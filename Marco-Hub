--// SERVICES
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

--// LIBRARY RAYFIELD
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "ü§ç MARCOO HUB ü§ç",
   LoadingTitle = "MARCOO HUB",
   LoadingSubtitle = "by Marcoo",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "MarcooHub",
      FileName = "Config"
   },
   Discord = {
      Enabled = false,
      Invite = "https://wa.me/+6285211384190", -- bisa isi kalau mau auto join Discord
      RememberJoins = true
   },
   KeySystem = true, -- ‚¨ÖÔ∏è aktifkan Key System
   KeySettings = {
      Title = "MARCOO HUB | Key System",
      Subtitle = "by Marcoo",
      Note = "Beli Key Ke Whatsapp NO WA 085211384190", -- teks info
      FileName = "MarcooKeyss", -- file buat simpan key
      SaveKey = true, -- biar gak perlu masukin ulang
      GrabKeyFromSite = false, -- kalau mau ambil key via web, set true
      Key = {"marcobaik", "flix123", "naokobaik"} -- daftar key valid
   }
})


--// TABS
local autoFarmTab = Window:CreateTab("Auto Farm", 4483362458)
local teleportTab = Window:CreateTab("Teleport", 4483362458)
local miscTab = Window:CreateTab("Misc", 4483362458)

--// FUNGSI PENDUKUNG
local function buyOnce(itemName)
    if not player.Backpack:FindFirstChild(itemName) and not player.Character:FindFirstChild(itemName) then
        ReplicatedStorage:WaitForChild("RequestItemPurchase"):FireServer(itemName)
    end
end

local teleportPoints = {
    CFrame.new(616.011353, 48.935448, 1069.656982),
    CFrame.new(1064.870117, 290.573914, 1089.163940),
    CFrame.new(811.049683, 610.731262, 136.814316),
    CFrame.new(874.904724, 435.305939, -347.736206),
    CFrame.new(676.620789, 889.230408, -885.985596),
    CFrame.new(180.518570, 947.355713, -1215.228516),
    CFrame.new(-537.126587, 1227.606934, -1117.816162),
    CFrame.new(60.901371, 1398.623291, -961.813843),
    CFrame.new(-328.328918, 1408.560547, -589.978333),
    CFrame.new(-423.375061, 1277.419312, -412.044556),
    CFrame.new(-387.709045, 1216.978027, -553.854126),
    CFrame.new(-424.629822, 1172.768921, -545.943359),
    CFrame.new(-568.202148, 840.997986, -469.531952),
    CFrame.new(-898.383911, 849.061951, -88.9551239),
    CFrame.new(-885.043579, 51.763824, 449.432617),
}
local function teleportPath(delayTime)
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    for _, cf in ipairs(teleportPoints) do
        hrp.CFrame = cf
        task.wait(delayTime)
    end
end

local antiAFKEnabled = false
local antiAFKConnection
local function toggleAntiAFK(bool)
    antiAFKEnabled = bool
    if antiAFKEnabled then
        if not antiAFKConnection then
            antiAFKConnection = player.Idled:Connect(function()
                VirtualUser:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
                task.wait(1)
                VirtualUser:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
            end)
        end
    else
        if antiAFKConnection then
            antiAFKConnection:Disconnect()
            antiAFKConnection = nil
        end
    end
end

-- Fungsi gendong (pakai RemoteEvent)
local RequestGendong = ReplicatedStorage:FindFirstChild("RequestGendong")
local function gendongPlayer(targetPlayerName)
    if RequestGendong and typeof(targetPlayerName) == "string" and targetPlayerName ~= "" then
        RequestGendong:FireServer(targetPlayerName)
        Rayfield:Notify({Title="‚úÖ Berhasil",Content="Menggendong "..targetPlayerName,Duration=3})
    else
        Rayfield:Notify({Title="‚ùå Gagal",Content="Player tidak valid atau RemoteEvent hilang",Duration=3})
    end
end

-- PENTING: Variabel global untuk setiap fitur auto
local isAutoFishEnabled = false
local isAutoBuyAntiFallEnabled = false
local isAutoBuyFoodEnabled = false
local characterAddedConnection = nil

--// FITUR AUTO FARM
autoFarmTab:CreateToggle({
    Name = "Auto Fish",
    CurrentValue = false,
    Callback = function(val)
        -- Menggunakan variabel global yang diperbarui
        isAutoFishEnabled = val 
        if isAutoFishEnabled then
            task.spawn(function()
                -- Menggunakan 'isAutoFishEnabled' untuk kontrol loop
                while isAutoFishEnabled do
                    task.wait()
                    local rod = player.Character:FindFirstChild("NormalRod")
                    if rod and rod:FindFirstChild("MiniGame") then
                        rod.MiniGame:FireServer("Complete")
                    end
                end
            end)
        end
    end
})

autoFarmTab:CreateToggle({
    Name = "Auto Buy Anti Fall",
    CurrentValue = false,
    Callback = function(val)
        isAutoBuyAntiFallEnabled = val
        
        local function buyAndUseAntiFall()
            buyOnce("Anti Fall Damage")
            task.wait(1)
            local antiFallTool = player.Backpack:FindFirstChild("Anti Fall Damage") or player.Character:FindFirstChild("Anti Fall Damage")
            if antiFallTool and antiFallTool:IsA("Tool") then
                antiFallTool.Parent = player.Character
                task.wait(0.5)
                antiFallTool:Activate()
            end
        end

        if isAutoBuyAntiFallEnabled then
            -- Beli saat ini juga
            buyAndUseAntiFall()
            
            -- Buat koneksi baru jika belum ada
            if not characterAddedConnection then
                characterAddedConnection = player.CharacterAdded:Connect(function()
                    -- Cek status lagi di dalam koneksi
                    if isAutoBuyAntiFallEnabled then
                        task.wait(1)
                        buyAndUseAntiFall()
                    end
                end)
            end
        else
            -- Putuskan koneksi saat tombol dimatikan
            if characterAddedConnection then
                characterAddedConnection:Disconnect()
                characterAddedConnection = nil
            end
        end
    end
})

autoFarmTab:CreateToggle({
    Name = "Auto Buy & Use Food/Drink",
    CurrentValue = false,
    Callback = function(val)
        -- Menggunakan variabel global yang diperbarui
        isAutoBuyFoodEnabled = val
        if isAutoBuyFoodEnabled then
            task.spawn(function()
                -- Menggunakan 'isAutoBuyFoodEnabled' untuk kontrol loop
                while isAutoBuyFoodEnabled do
                    buyOnce("Burgerr")
                    task.wait(0.5)
                    local burgerr = player.Backpack:FindFirstChild("Burgerr")
                    if burgerr then
                        burgerr.Parent = player.Character
                        task.wait(0.5)
                        burgerr:Activate()
                    end
                    buyOnce("Air Minum")
                    task.wait(0.5)
                    local air = player.Backpack:FindFirstChild("Air Minum")
                    if air then
                        air.Parent = player.Character
                        task.wait(0.5)
                        air:Activate()
                    end
                    task.wait(480)
                end
            end)
        end
    end
})

--// FITUR TELEPORT
teleportTab:CreateButton({
    Name = "TP Finish (1 Detik)",
    Callback = function() teleportPath(1) end
})
teleportTab:CreateButton({
    Name = "TP Finish (5 Detik)",
    Callback = function() teleportPath(5) end
})

local customDelay = 1
teleportTab:CreateInput({
    Name = "Custom Delay (detik):",
    PlaceholderText = "1",
    RemoveTextAfterFocusLost = false,
    Callback = function(val)
        local num = tonumber(val)
        if num then customDelay = num end
    end
})
teleportTab:CreateButton({
    Name = "Start TP (Custom)",
    Callback = function()
        teleportPath(customDelay)
    end
})

-- ‚ú® Custom Player Gendong
local carryTarget = ""
teleportTab:CreateInput({
    Name = "Player untuk digendong:",
    PlaceholderText = "Nama Pemain",
    RemoveTextAfterFocusLost = false,
    Callback = function(val)
        carryTarget = val
    end
})
teleportTab:CreateButton({
    Name = "Gendong Pemain",
    Callback = function()
        gendongPlayer(carryTarget)
    end
})

--// MISC
miscTab:CreateToggle({
    Name = "Anti AFK",
    CurrentValue = false,
    Callback = toggleAntiAFK
})
miscTab:CreateButton({
    Name = "Ambil Pancingan",
    Callback = function()
        local args = {"NormalRod",1}
        ReplicatedStorage.RemoteEvents.BankWithdraw:FireServer(unpack(args))
    end
})
miscTab:CreateButton({
    Name = "Simpan Pancingan",
    Callback = function()
        local args = {"NormalRod",1}
        ReplicatedStorage.RemoteFunctions.TryDepositItem:InvokeServer(unpack(args))
        task.wait(0.5)
        ReplicatedStorage.RemoteEvents.BankDeposit:FireServer(unpack(args))
    end
})
